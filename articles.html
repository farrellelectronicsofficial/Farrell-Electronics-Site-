<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Articles — Farrell Electronics</title>
    <!-- Firebase SDK via Import Map -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"
      }
    }
    </script>
    <style>
      :root{--bg:#ffffff;--card:#fff;--accent:#1a3a6b;--muted:#4a5568;--danger:#c33c1d}
      body{font-family:Tahoma,sans-serif;background:var(--bg);color:#1a2332;margin:0}
      .site{max-width:960px;margin:32px auto;padding:20px}
      header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
      h1{font-size:20px;margin:0}
      h2{font-size:18px;margin-top:0}
      .header-buttons{display:flex;gap:10px;align-items:center}
      .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-size:14px;text-decoration:none}
      .btn:hover{opacity:0.9}
      .btn-danger{background:var(--danger)}
      .btn-secondary{background:#4a5568;color:#fff}
      .btn-sm{padding:8px 12px;font-size:12px}
      .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(8,23,42,0.06);margin-bottom:16px}
      .card-article{cursor:pointer;transition:box-shadow 0.2s}
      .card-article:hover{box-shadow:0 6px 18px rgba(8,23,42,0.12)}
      label{display:block;font-weight:600;margin-bottom:6px;margin-top:12px}
      label:first-child{margin-top:0}
      input[type=text],textarea,input[type=password]{width:100%;padding:10px;border:1px solid #e6eef6;border-radius:8px;margin-bottom:12px;box-sizing:border-box;font-family:inherit}
      textarea{resize:vertical;min-height:150px}
      .muted{color:var(--muted);font-size:13px}
      .small{font-size:13px}
      footer{margin-top:20px;color:var(--muted);font-size:13px}
      .article-header{display:flex;justify-content:space-between;align-items:flex-start}
      .article-title{font-size:18px;font-weight:700;margin:0 0 4px 0}
      .article-meta{color:var(--muted);font-size:13px;margin-bottom:12px}
      .article-content{line-height:1.6;margin:12px 0}
      .admin-badge{background:var(--accent);color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;display:inline-block;margin-left:8px}
      .hidden{display:none}
      .admin-form{background:#f5f7fb;border:1px solid #d0d8e8;padding:12px;border-radius:8px;margin-bottom:16px}
      .success-msg{background:#f0fff4;border:1px solid #c6f6d5;color:#22543d;padding:12px;border-radius:8px;margin-bottom:12px}
      .no-articles{text-align:center;color:var(--muted);padding:40px 20px}
      .admin-controls{display:flex;gap:8px;margin-top:12px}
      .admin-controls button{font-size:12px;padding:6px 10px}
      
      /* Modal styles */
      .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5)}
      .modal.active{display:flex;align-items:center;justify-content:center}
      .modal-content{background-color:var(--card);padding:30px;border-radius:12px;width:90%;max-width:400px;box-shadow:0 6px 20px rgba(8,23,42,0.15)}
      .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
      .modal-header h2{margin:0}
      .close-modal{background:none;border:none;font-size:28px;cursor:pointer;color:var(--muted)}
      .close-modal:hover{color:#06202a}
      .login-error{background:#fff5f5;border:1px solid #feb2b2;color:var(--danger);padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px}
    </style>
  </head>
  <body>
    <div class="site">
      <header>
        <div>
          <h1>Articles — Farrell Electronics</h1>
          <div class="muted small">Latest news and updates</div>
        </div>
        <div class="header-buttons">
          <a href="home.html" class="btn btn-secondary">Home</a>
          <a href="index.html" class="btn btn-secondary">Trade-In</a>
          <a href="listings.html" class="btn btn-secondary">Listings</a>
          <button class="btn btn-sm" id="adminLoginBtn">Admin Login</button>
          <button class="btn btn-sm btn-secondary hidden" id="logoutBtn">Logout</button>
        </div>
      </header>

      <!-- Admin Panel (hidden by default) -->
      <div id="adminPanel" class="hidden">
        <div class="card admin-form">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2>Post Article</h2>
          </div>
          
          <div id="successMsg" class="success-msg hidden"></div>

          <label for="articleTitle">Article Title</label>
          <input type="text" id="articleTitle" placeholder="Enter article title" />

          <label for="articleContent">Article Content</label>
          <textarea id="articleContent" placeholder="Write your article here..."></textarea>

          <div style="display:flex;gap:12px">
            <button class="btn" id="publishBtn">Publish Article</button>
            <button class="btn btn-secondary" id="clearFormBtn">Clear</button>
          </div>
        </div>
      </div>

      <main id="articlesContainer">
        <!-- Articles will be loaded here -->
      </main>

      <footer>
        Contact us on <a href="https://www.facebook.com/marketplace/profile/61554953247457/" target="_blank">Facebook</a> for more information.
      </footer>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Admin Login</h2>
          <button class="close-modal" id="closeModalBtn">&times;</button>
        </div>
        <div id="loginError" class="login-error hidden"></div>
        <label for="adminPassword">Password</label>
        <input type="password" id="adminPassword" placeholder="Enter admin password" />
        <button class="btn" id="loginBtn" style="width:100%">Login</button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from 'firebase/app';
      import { getFirestore, collection, doc, onSnapshot, addDoc, query, orderBy, deleteDoc } from 'firebase/firestore';

      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyAciAwaqVsB8ZYpVaq9mxkRsh44yl9Yxj4",
        authDomain: "farrellelectronics-home-site.firebaseapp.com",
        projectId: "farrellelectronics-home-site",
        storageBucket: "farrellelectronics-home-site.firebasestorage.app",
        messagingSenderId: "723476822694",
        appId: "1:723476822694:web:a9dcd471f4df668fafd267"
      };

      // Initialize Firebase
      let db;
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log('Firebase initialized successfully');
      } catch (err) {
        console.error('Firebase initialization error:', err);
      }

      const ADMIN_PASSWORD = '2011birth*';

      // DOM Elements
      const articlesContainer = document.getElementById('articlesContainer');
      const adminPanel = document.getElementById('adminPanel');
      const loginModal = document.getElementById('loginModal');
      const articleTitle = document.getElementById('articleTitle');
      const articleContent = document.getElementById('articleContent');
      const publishBtn = document.getElementById('publishBtn');
      const clearFormBtn = document.getElementById('clearFormBtn');
      const loginBtn = document.getElementById('loginBtn');
      const adminLoginBtn = document.getElementById('adminLoginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const adminPassword = document.getElementById('adminPassword');
      const loginError = document.getElementById('loginError');
      const successMsg = document.getElementById('successMsg');

      let isLoggedIn = false;

      function checkLogin() {
        const loginStatus = localStorage.getItem('farrell_admin_articles_session');
        isLoggedIn = loginStatus === 'true';
        updateUIState();
      }

      function updateUIState() {
        if (isLoggedIn) {
          adminLoginBtn.classList.add('hidden');
          logoutBtn.classList.remove('hidden');
          adminPanel.classList.remove('hidden');
        } else {
          adminLoginBtn.classList.remove('hidden');
          logoutBtn.classList.add('hidden');
          adminPanel.classList.add('hidden');
        }
        renderArticles();
      }

      function openLoginModal() {
        loginModal.classList.add('active');
        adminPassword.focus();
        loginError.classList.add('hidden');
        adminPassword.value = '';
      }

      function closeLoginModal() {
        loginModal.classList.remove('active');
        adminPassword.value = '';
        loginError.classList.add('hidden');
      }

      // Attach event listeners with null checks
      if (loginBtn) {
        loginBtn.addEventListener('click', () => {
          if (adminPassword.value === ADMIN_PASSWORD) {
            localStorage.setItem('farrell_admin_articles_session', 'true');
            closeLoginModal();
            checkLogin();
          } else {
            loginError.textContent = 'Incorrect password. Please try again.';
            loginError.classList.remove('hidden');
            adminPassword.value = '';
            adminPassword.focus();
          }
        });
      }

      if (adminPassword) {
        adminPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && loginBtn) loginBtn.click();
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('farrell_admin_articles_session');
          checkLogin();
        });
      }

      if (adminLoginBtn) {
        adminLoginBtn.addEventListener('click', openLoginModal);
      }

      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeLoginModal);
      }

      if (loginModal) {
        loginModal.addEventListener('click', (e) => {
          if (e.target === loginModal) closeLoginModal();
        });
      }

      // Publish button with null check
      if (publishBtn) {
        publishBtn.addEventListener('click', () => {
          const title = articleTitle.value.trim();
          const content = articleContent.value.trim();

          if (!title) {
            alert('Please enter a title');
            return;
          }
          if (!content) {
            alert('Please enter content');
            return;
          }

          addDoc(collection(db, 'articles'), {
            title,
            content,
            date: new Date().toISOString()
          }).then(() => {
            console.log('Article published successfully');
            successMsg.textContent = 'Article published successfully!';
            successMsg.classList.remove('hidden');
            setTimeout(() => {
              successMsg.classList.add('hidden');
            }, 3000);

            articleTitle.value = '';
            articleContent.value = '';
            renderArticles();
          }).catch((err) => {
            console.error('Error publishing article:', err);
            alert('Error publishing article: ' + err.message);
          });
        });
      }

      if (clearFormBtn) {
        clearFormBtn.addEventListener('click', () => {
          articleTitle.value = '';
          articleContent.value = '';
        });
      }

      // Render articles from Firestore
      function renderArticles() {
        const q = query(collection(db, 'articles'), orderBy('date', 'desc'));
        onSnapshot(q, (querySnapshot) => {
          const articles = [];
          querySnapshot.forEach((doc) => {
            articles.push({ id: doc.id, ...doc.data() });
          });

          if (articles.length === 0) {
            articlesContainer.innerHTML = '<div class="no-articles"><p>No articles yet.</p></div>';
            return;
          }

          articlesContainer.innerHTML = articles
            .map((article) => `
              <div class="card card-article">
                <div class="article-header">
                  <div>
                    <h3 class="article-title">${escapeHtml(article.title)}</h3>
                    <div class="article-meta">
                      ${formatDate(article.date)}
                      <span class="admin-badge">ADMIN</span>
                    </div>
                  </div>
                  ${isLoggedIn ? `
                    <button class="btn btn-danger btn-sm" onclick="deleteArticle('${article.id}')">Delete</button>
                  ` : ''}
                </div>
                <div class="article-content">${escapeHtml(article.content).replace(/\n/g, '<br>')}</div>
              </div>
            `).join('');
        }, (err) => {
          console.log('Articles collection not yet created or permission issue:', err.message);
          articlesContainer.innerHTML = '<div class="no-articles"><p>No articles yet.</p></div>';
        });
      }

      function deleteArticle(articleId) {
        if (confirm('Are you sure you want to delete this article?')) {
          deleteDoc(doc(db, 'articles', articleId));
        }
      }

      publishBtn.addEventListener('click', () => {
        const title = articleTitle.value.trim();
        const content = articleContent.value.trim();

        if (!title) {
          alert('Please enter a title');
          return;
        }
        if (!content) {
          alert('Please enter content');
          return;
        }

        db.collection('articles').add({
          title,
          content,
          date: new Date().toISOString()
        }).then(() => {
          successMsg.textContent = 'Article published successfully!';
          successMsg.classList.remove('hidden');
          setTimeout(() => {
            successMsg.classList.add('hidden');
          }, 3000);

          articleTitle.value = '';
          articleContent.value = '';
          renderArticles();
        });
      });

      clearFormBtn.addEventListener('click', () => {
        articleTitle.value = '';
        articleContent.value = '';
      });

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(isoDate) {
        const date = new Date(isoDate);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }

      // Initialize
      console.log('Initializing articles app...');
      console.log('DB instance:', db ? 'ready' : 'not ready');
      checkLogin();

      // Make functions globally accessible for onclick handlers
      window.deleteArticle = deleteArticle;
    </script>
  </body>
</html>
