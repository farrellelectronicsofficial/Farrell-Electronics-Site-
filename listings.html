<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Listings — Farrell Electronics</title>
    <!-- Firebase SDK via Import Map -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js",
        "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js"
      }
    }
    </script>
    <style>
      :root{--bg:#ffffff;--card:#fff;--accent:#1a3a6b;--muted:#4a5568;--danger:#c33c1d}
      body{font-family:Tahoma,sans-serif;background:var(--bg);color:#1a2332;margin:0}
      .site{max-width:960px;margin:32px auto;padding:20px}
      header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
      h1{font-size:20px;margin:0}
      h2{font-size:18px;margin-top:0}
      .header-buttons{display:flex;gap:10px;align-items:center}
      .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-size:14px;text-decoration:none;display:inline-block}
      .btn:hover{opacity:0.9}
      .btn-danger{background:var(--danger)}
      .btn-secondary{background:#4a5568;color:#fff}
      .btn-sm{padding:8px 12px;font-size:12px}
      .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(8,23,42,0.06);margin-bottom:16px}
      label{display:block;font-weight:600;margin-bottom:6px;margin-top:12px}
      label:first-child{margin-top:0}
      input[type=text],input[type=url],textarea,input[type=password],input[type=number],input[type=file]{width:100%;padding:10px;border:1px solid #d0d8e8;border-radius:8px;margin-bottom:12px;box-sizing:border-box;font-family:inherit}
      input[type=file]{padding:6px}
      textarea{resize:vertical;min-height:100px}
      .muted{color:var(--muted);font-size:13px}
      .small{font-size:13px}
      footer{margin-top:20px;color:var(--muted);font-size:13px}
      a{color:var(--accent);text-decoration:none}
      a:hover{text-decoration:underline}
      .hidden{display:none}
      .admin-form{background:#f5f7fb;border:1px solid #d0d8e8;padding:12px;border-radius:8px;margin-bottom:16px}
      .success-msg{background:#f0fff4;border:1px solid #c6f6d5;color:#22543d;padding:12px;border-radius:8px;margin-bottom:12px}
      .no-listings{text-align:center;color:var(--muted);padding:40px 20px}
      
      /* Listings Grid */
      .listings-grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));margin-bottom:20px}
      .listing-card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(26,58,107,0.1);transition:box-shadow 0.3s}
      .listing-card:hover{box-shadow:0 6px 18px rgba(26,58,107,0.15)}
      .listing-image{width:100%;height:200px;object-fit:cover;background:#f5f7fb}
      .listing-body{padding:16px}
      .listing-title{font-size:16px;font-weight:700;margin:0 0 8px 0;color:#1a2332}
      .listing-price{font-size:20px;font-weight:700;color:var(--accent);margin:8px 0}
      .listing-meta{font-size:12px;color:var(--muted);margin-bottom:12px}
      .listing-link{display:inline-block;margin-top:8px}
      .listing-actions{display:flex;gap:8px;margin-top:12px}
      
      /* Modal styles */
      .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);overflow-y:auto}
      .modal.active{display:flex;align-items:flex-start;justify-content:center;padding:20px 0}
      .modal-content{background-color:var(--card);padding:30px;border-radius:12px;width:90%;max-width:500px;box-shadow:0 6px 20px rgba(26,58,107,0.15);margin-top:20px}
      .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
      .modal-header h2{margin:0}
      .close-modal{background:none;border:none;font-size:28px;cursor:pointer;color:var(--muted)}
      .close-modal:hover{color:#1a2332}
      .login-error{background:#fff5f5;border:1px solid #f5d5c8;color:var(--danger);padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px}
      
      /* Image preview */
      .image-preview{width:100%;max-width:200px;margin-top:8px;border-radius:6px;border:1px solid #d0d8e8}
      .form-row{display:flex;gap:12px}
      .form-row > div{flex:1}
    </style>
  </head>
  <body>
    <div class="site">
      <header>
        <div>
          <h1>Listings — Farrell Electronics</h1>
          <div class="muted small">Currently available items for sale</div>
        </div>
        <div class="header-buttons">
          <a href="home.html" class="btn btn-secondary">Home</a>
          <a href="index.html" class="btn btn-secondary">Trade-In</a>
          <a href="articles.html" class="btn btn-secondary">Articles</a>
          <button class="btn btn-sm" id="adminLoginBtn">Admin Login</button>
          <button class="btn btn-sm btn-secondary hidden" id="logoutBtn">Logout</button>
        </div>
      </header>

      <!-- Admin Panel (hidden by default) -->
      <div id="adminPanel" class="hidden">
        <div class="card admin-form">
          <h2>Add New Listing</h2>
          
          <div id="successMsg" class="success-msg hidden"></div>

          <label for="listingTitle">Listing Title</label>
          <input type="text" id="listingTitle" placeholder="e.g., Samsung Galaxy S24 128GB Black" />

          <div class="form-row">
            <div>
              <label for="listingPrice">Price ($)</label>
              <input type="number" id="listingPrice" placeholder="0.00" step="0.01" min="0" />
            </div>
            <div>
              <label for="listingEbayLink">eBay Link</label>
              <input type="url" id="listingEbayLink" placeholder="https://ebay.com/itm/..." />
            </div>
          </div>

          <label for="listingPhoto">Photo</label>
          <input type="file" id="listingPhoto" accept="image/*" />
          <div id="photoPreview"></div>

          <label for="listingDescription">Description (Optional)</label>
          <textarea id="listingDescription" placeholder="Add any additional details..."></textarea>

          <div style="display:flex;gap:12px">
            <button class="btn" id="publishBtn">Add Listing</button>
            <button class="btn btn-secondary" id="clearFormBtn">Clear</button>
          </div>
        </div>
      </div>

      <main id="listingsContainer">
        <!-- Listings will be loaded here -->
      </main>

      <footer>
        Contact us on <a href="https://www.facebook.com/marketplace/profile/61554953247457/" target="_blank">Facebook</a> for more information.
      </footer>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Admin Login</h2>
          <button class="close-modal" id="closeModalBtn">&times;</button>
        </div>
        <div id="loginError" class="login-error hidden"></div>
        <label for="adminPassword">Password</label>
        <input type="password" id="adminPassword" placeholder="Enter admin password" />
        <button class="btn" id="loginBtn" style="width:100%">Login</button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from 'firebase/app';
      import { getFirestore, collection, doc, onSnapshot, addDoc, query, orderBy, deleteDoc } from 'firebase/firestore';

      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyAciAwaqVsB8ZYpVaq9mxkRsh44yl9Yxj4",
        authDomain: "farrellelectronics-home-site.firebaseapp.com",
        projectId: "farrellelectronics-home-site",
        storageBucket: "farrellelectronics-home-site.firebasestorage.app",
        messagingSenderId: "723476822694",
        appId: "1:723476822694:web:a9dcd471f4df668fafd267"
      };

      // Initialize Firebase
      let db;
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log('Firebase initialized successfully');
      } catch (err) {
        console.error('Firebase initialization error:', err);
      }

      const ADMIN_PASSWORD = '2011birth*';

      // DOM Elements
      const listingsContainer = document.getElementById('listingsContainer');
      const adminPanel = document.getElementById('adminPanel');
      const loginModal = document.getElementById('loginModal');
      const listingTitle = document.getElementById('listingTitle');
      const listingPrice = document.getElementById('listingPrice');
      const listingEbayLink = document.getElementById('listingEbayLink');
      const listingPhoto = document.getElementById('listingPhoto');
      const listingDescription = document.getElementById('listingDescription');
      const publishBtn = document.getElementById('publishBtn');
      const clearFormBtn = document.getElementById('clearFormBtn');
      const loginBtn = document.getElementById('loginBtn');
      const adminLoginBtn = document.getElementById('adminLoginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const adminPassword = document.getElementById('adminPassword');
      const loginError = document.getElementById('loginError');
      const successMsg = document.getElementById('successMsg');
      const photoPreview = document.getElementById('photoPreview');

      let currentPhotoData = null;
      let isLoggedIn = false;

      function checkLogin() {
        const loginStatus = localStorage.getItem('farrell_admin_listings_session');
        isLoggedIn = loginStatus === 'true';
        updateUIState();
      }

      function updateUIState() {
        if (isLoggedIn) {
          adminLoginBtn.classList.add('hidden');
          logoutBtn.classList.remove('hidden');
          adminPanel.classList.remove('hidden');
        } else {
          adminLoginBtn.classList.remove('hidden');
          logoutBtn.classList.add('hidden');
          adminPanel.classList.add('hidden');
        }
        renderListings();
      }

      function openLoginModal() {
        loginModal.classList.add('active');
        adminPassword.focus();
        loginError.classList.add('hidden');
        adminPassword.value = '';
      }

      function closeLoginModal() {
        loginModal.classList.remove('active');
        adminPassword.value = '';
        loginError.classList.add('hidden');
      }

      // Attach event listeners with null checks
      if (loginBtn) {
        loginBtn.addEventListener('click', () => {
          if (adminPassword.value === ADMIN_PASSWORD) {
            localStorage.setItem('farrell_admin_listings_session', 'true');
            closeLoginModal();
            checkLogin();
          } else {
            loginError.textContent = 'Incorrect password. Please try again.';
            loginError.classList.remove('hidden');
            adminPassword.value = '';
            adminPassword.focus();
          }
        });
      }

      if (adminPassword) {
        adminPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && loginBtn) loginBtn.click();
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('farrell_admin_listings_session');
          checkLogin();
        });
      }

      if (adminLoginBtn) {
        adminLoginBtn.addEventListener('click', openLoginModal);
      }

      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeLoginModal);
      }

      if (loginModal) {
        loginModal.addEventListener('click', (e) => {
          if (e.target === loginModal) closeLoginModal();
        });
      }

      if (listingPhoto) {
        listingPhoto.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              currentPhotoData = event.target.result;
              photoPreview.innerHTML = `<img src="${currentPhotoData}" class="image-preview" alt="Preview">`;
            };
            reader.readAsDataURL(file);
          }
        });
      }

      // Publish button with null check
      if (publishBtn) {
        publishBtn.addEventListener('click', () => {
          const title = listingTitle.value.trim();
          const price = listingPrice.value.trim();
          const ebayLink = listingEbayLink.value.trim();
          const description = listingDescription.value.trim();

          if (!title) {
            alert('Please enter a title');
            return;
          }
          if (!price) {
            alert('Please enter a price');
            return;
          }
          if (!ebayLink) {
            alert('Please enter an eBay link');
            return;
          }
          if (!currentPhotoData) {
            alert('Please upload a photo');
            return;
          }

          addDoc(collection(db, 'listings'), {
            title,
            price: parseFloat(price),
            ebayLink,
            description,
            photo: currentPhotoData,
            date: new Date().toISOString()
          }).then(() => {
            successMsg.textContent = 'Listing added successfully!';
            successMsg.classList.remove('hidden');
            setTimeout(() => {
              successMsg.classList.add('hidden');
            }, 3000);

            listingTitle.value = '';
            listingPrice.value = '';
            listingEbayLink.value = '';
            listingDescription.value = '';
            listingPhoto.value = '';
            currentPhotoData = null;
            photoPreview.innerHTML = '';
            renderListings();
          }).catch((err) => {
            console.error('Error adding listing:', err);
            alert('Error adding listing: ' + err.message);
          });
        });
      }

      if (clearFormBtn) {
        clearFormBtn.addEventListener('click', () => {
          listingTitle.value = '';
          listingPrice.value = '';
          listingEbayLink.value = '';
          listingDescription.value = '';
          listingPhoto.value = '';
          currentPhotoData = null;
          photoPreview.innerHTML = '';
        });
      }

      // Render listings from Firestore
      function renderListings() {
        const q = query(collection(db, 'listings'), orderBy('date', 'desc'));
        onSnapshot(q, (querySnapshot) => {
          const listings = [];
          querySnapshot.forEach((doc) => {
            listings.push({ id: doc.id, ...doc.data() });
          });

          if (listings.length === 0) {
            listingsContainer.innerHTML = '<div class="no-listings"><p>No listings available at this time.</p></div>';
            return;
          }

          listingsContainer.innerHTML = '<div class="listings-grid">' + listings
            .map((listing) => `
              <div class="listing-card">
                ${listing.photo ? `<img src="${listing.photo}" class="listing-image" alt="${escapeHtml(listing.title)}">` : '<div class="listing-image" style="background:#f5f7fb;display:flex;align-items:center;justify-content:center;color:#4a5568">No photo</div>'}
                <div class="listing-body">
                  <h3 class="listing-title">${escapeHtml(listing.title)}</h3>
                  <div class="listing-price">$${parseFloat(listing.price).toFixed(2)}</div>
                  ${listing.description ? `<div style="font-size:13px;margin-bottom:8px;color:#4a5568">${escapeHtml(listing.description)}</div>` : ''}
                  <div class="listing-meta">Added ${formatDate(listing.date)}</div>
                  <a href="${escapeHtml(listing.ebayLink)}" target="_blank" class="btn listing-link" style="font-size:12px;padding:6px 10px">View on eBay</a>
                  ${isLoggedIn ? `
                    <div class="listing-actions">
                      <button class="btn btn-danger btn-sm" onclick="deleteListing('${listing.id}')">Delete</button>
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('') + '</div>';
        });
      }

      function deleteListing(listingId) {
        if (confirm('Are you sure you want to delete this listing?')) {
          deleteDoc(doc(db, 'listings', listingId));
        }
      }

      function deleteListing(listingId) {
        if (confirm('Are you sure you want to delete this listing?')) {
          db.collection('listings').doc(listingId).delete();
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(isoDate) {
        const date = new Date(isoDate);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }

      // Initialize
      console.log('Initializing listings app...');
      console.log('DB instance:', db ? 'ready' : 'not ready');
      checkLogin();

      // Make functions globally accessible for onclick handlers
      window.deleteListing = deleteListing;
    </script>
  </body>
</html>
