<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Firebase Connection Test â€” Farrell Electronics</title>
    <!-- Firebase SDK via Import Map -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"
      }
    }
    </script>
    <style>
      :root{--bg:#ffffff;--card:#fff;--accent:#1a3a6b;--muted:#4a5568;--danger:#c33c1d}
      body{font-family:Tahoma,sans-serif;background:var(--bg);color:#1a2332;margin:0;padding:20px}
      .container{max-width:960px;margin:0 auto}
      h1{color:var(--accent);margin-bottom:30px}
      h2{color:var(--accent);margin-top:30px;font-size:18px}
      .section{background:var(--card);border:1px solid #e0e0e0;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
      .btn{background:var(--accent);color:#fff;padding:8px 12px;border:none;border-radius:4px;cursor:pointer;font-size:13px;margin-right:8px;margin-bottom:8px}
      .btn:hover{opacity:0.9}
      .btn-danger{background:var(--danger)}
      .btn-success{background:#22863a}
      .status{padding:10px;border-radius:4px;margin-bottom:10px;font-size:13px;font-weight:600}
      .status.success{background:#f0fff4;border:1px solid #c6f6d5;color:#22543d}
      .status.error{background:#fff5f5;border:1px solid #feb2b2;color:var(--danger)}
      .status.warning{background:#fffaf0;border:1px solid #fed7aa;color:#7c2d12}
      .log{background:#f5f5f5;border:1px solid #ddd;border-radius:4px;padding:12px;font-size:12px;font-family:monospace;max-height:300px;overflow-y:auto;margin-bottom:10px}
      .log-entry{margin:4px 0;padding:4px 0;border-bottom:1px solid #eee}
      .log-entry:last-child{border-bottom:none}
      .log-entry.success{color:#22543d}
      .log-entry.error{color:var(--danger)}
      .log-entry.info{color:#1a3a6b}
      table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
      th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd}
      th{background:#f5f5f5;font-weight:600;color:var(--accent)}
      tr:hover{background:#f9f9f9}
      .hidden{display:none}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ§ª Firebase Connection Test</h1>

      <!-- Firebase Status -->
      <div class="section">
        <h2>Firebase Status</h2>
        <div id="firebaseStatus" class="status warning">Initializing...</div>
        <button class="btn" onclick="testFirebase()">Test Firebase Connection</button>
        <button class="btn" onclick="clearLogs()">Clear Logs</button>
        <div id="firebaseLog" class="log"></div>
      </div>

      <!-- Announcements -->
      <div class="section">
        <h2>Announcements (site/announcement)</h2>
        <button class="btn" onclick="testSaveAnnouncement()">Save Test Announcement</button>
        <button class="btn" onclick="testLoadAnnouncement()">Load Announcement</button>
        <button class="btn btn-danger" onclick="testDeleteAnnouncement()">Delete Announcement</button>
        <div id="announcementLog" class="log"></div>
        <div id="announcementData" style="margin-top:10px;padding:10px;background:#f5f5f5;border-radius:4px;display:none">
          <strong>Current Data:</strong>
          <pre id="announcementContent" style="margin:5px 0;font-size:12px"></pre>
        </div>
      </div>

      <!-- Newsletters -->
      <div class="section">
        <h2>Newsletters Collection</h2>
        <button class="btn" onclick="testAddNewsletter()">Add Test Subscriber</button>
        <button class="btn" onclick="testLoadNewsletters()">Load Newsletter Subscribers</button>
        <button class="btn btn-danger" onclick="testClearNewsletters()">Delete All Subscribers</button>
        <div id="newsletterLog" class="log"></div>
        <div id="newsletterData" style="margin-top:10px;display:none">
          <table>
            <thead>
              <tr><th>Email</th><th>Date</th></tr>
            </thead>
            <tbody id="newsletterTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Articles -->
      <div class="section">
        <h2>Articles Collection</h2>
        <button class="btn" onclick="testAddArticle()">Add Test Article</button>
        <button class="btn" onclick="testLoadArticles()">Load Articles</button>
        <button class="btn btn-danger" onclick="testClearArticles()">Delete All Articles</button>
        <div id="articleLog" class="log"></div>
        <div id="articleData" style="margin-top:10px;display:none">
          <table>
            <thead>
              <tr><th>Title</th><th>Date</th><th>ID</th></tr>
            </thead>
            <tbody id="articleTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Listings -->
      <div class="section">
        <h2>Listings Collection</h2>
        <button class="btn" onclick="testAddListing()">Add Test Listing</button>
        <button class="btn" onclick="testLoadListings()">Load Listings</button>
        <button class="btn btn-danger" onclick="testClearListings()">Delete All Listings</button>
        <div id="listingLog" class="log"></div>
        <div id="listingData" style="margin-top:10px;display:none">
          <table>
            <thead>
              <tr><th>Title</th><th>Price</th><th>Date</th><th>ID</th></tr>
            </thead>
            <tbody id="listingTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from 'firebase/app';
      import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, query, orderBy, getDocs, deleteDoc, writeBatch } from 'firebase/firestore';

      const firebaseConfig = {
        apiKey: "AIzaSyAciAwaqVsB8ZYpVaq9mxkRsh44yl9Yxj4",
        authDomain: "farrellelectronics-home-site.firebaseapp.com",
        projectId: "farrellelectronics-home-site",
        storageBucket: "farrellelectronics-home-site.firebasestorage.app",
        messagingSenderId: "723476822694",
        appId: "1:723476822694:web:a9dcd471f4df668fafd267"
      };

      let db;
      let isConnected = false;

      // Initialize Firebase
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        isConnected = true;
        log('firebase', 'Firebase initialized successfully', 'success');
      } catch (err) {
        log('firebase', 'Firebase initialization error: ' + err.message, 'error');
      }

      // Update status
      function updateStatus(section, isSuccess, message) {
        const el = document.getElementById(section + 'Status');
        if (!el) return;
        el.className = 'status ' + (isSuccess ? 'success' : 'error');
        el.textContent = message;
      }

      // Logging function
      function log(section, message, type = 'info') {
        console.log(`[${section}] ${message}`);
        const logEl = document.getElementById(section + 'Log');
        if (!logEl) return;
        
        const entry = document.createElement('div');
        entry.className = 'log-entry ' + type;
        entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function clearLogs() {
        document.querySelectorAll('.log').forEach(el => el.innerHTML = '');
      }

      // Firebase Connection Test
      window.testFirebase = async function() {
        log('firebase', 'Testing Firebase connection...', 'info');
        try {
          if (!db) throw new Error('Firestore not initialized');
          const testRef = doc(db, 'test', 'connection');
          await setDoc(testRef, { timestamp: new Date().toISOString() });
          await deleteDoc(testRef);
          log('firebase', 'âœ“ Firebase connection successful (write/delete test passed)', 'success');
          updateStatus('firebase', true, 'âœ“ Connected');
        } catch (err) {
          log('firebase', 'âœ— Connection failed: ' + err.message, 'error');
          updateStatus('firebase', false, 'âœ— Error: ' + err.message);
        }
      };

      // Announcement Tests
      window.testSaveAnnouncement = async function() {
        log('announcement', 'Saving test announcement...', 'info');
        try {
          await setDoc(doc(db, 'site', 'announcement'), {
            text: 'TEST ANNOUNCEMENT - ' + new Date().toLocaleTimeString(),
            date: new Date().toISOString()
          });
          log('announcement', 'âœ“ Announcement saved successfully', 'success');
        } catch (err) {
          log('announcement', 'âœ— Error: ' + err.message, 'error');
        }
      };

      window.testLoadAnnouncement = async function() {
        log('announcement', 'Loading announcement...', 'info');
        try {
          const currentDoc = await onSnapshot(doc(db, 'site', 'announcement'), (docSnap) => {
            if (docSnap.exists()) {
              const data = docSnap.data();
              log('announcement', 'âœ“ Announcement loaded: ' + data.text, 'success');
              document.getElementById('announcementData').style.display = 'block';
              document.getElementById('announcementContent').textContent = JSON.stringify(data, null, 2);
            } else {
              log('announcement', 'No announcement found', 'warning');
              document.getElementById('announcementData').style.display = 'none';
            }
          });
        } catch (err) {
          log('announcement', 'âœ— Error: ' + err.message, 'error');
        }
      };

      window.testDeleteAnnouncement = async function() {
        log('announcement', 'Deleting announcement...', 'info');
        try {
          await deleteDoc(doc(db, 'site', 'announcement'));
          log('announcement', 'âœ“ Announcement deleted', 'success');
          document.getElementById('announcementData').style.display = 'none';
        } catch (err) {
          log('announcement', 'âœ— Error: ' + err.message, 'error');
        }
      };

      // Newsletter Tests
      window.testAddNewsletter = async function() {
        log('newsletter', 'Adding test subscriber...', 'info');
        try {
          await addDoc(collection(db, 'newsletters'), {
            email: 'test_' + Date.now() + '@test.com',
            date: new Date().toISOString()
          });
          log('newsletter', 'âœ“ Subscriber added', 'success');
        } catch (err) {
          log('newsletter', 'âœ— Error: ' + err.message, 'error');
        }
      };

      window.testLoadNewsletters = async function() {
        log('newsletter', 'Loading newsletters...', 'info');
        try {
          const q = query(collection(db, 'newsletters'), orderBy('date', 'desc'));
          const querySnapshot = await getDocs(q);
          document.getElementById('newsletterTable').innerHTML = '';
          
          if (querySnapshot.empty) {
            log('newsletter', 'No newsletters found', 'warning');
          } else {
            log('newsletter', 'âœ“ Loaded ' + querySnapshot.size + ' newsletters', 'success');
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const row = document.createElement('tr');
              row.innerHTML = `<td>${data.email}</td><td>${new Date(data.date).toLocaleString()}</td><td>${doc.id}</td>`;
              document.getElementById('newsletterTable').appendChild(row);
            });
            document.getElementById('newsletterData').style.display = 'block';
          }
        } catch (err) {
          log('newsletter', 'âœ— Error: ' + err.message, 'error');
        }
      };

      window.testClearNewsletters = async function() {
        if (!confirm('Delete all newsletters?')) return;
        log('newsletter', 'Deleting all newsletters...', 'info');
        try {
          const q = query(collection(db, 'newsletters'));
          const querySnapshot = await getDocs(q);
          const batch = writeBatch(db);
          
          querySnapshot.forEach((doc) => {
            batch.delete(doc.ref);
          });
          
          await batch.commit();
          log('newsletter', 'âœ“ Deleted ' + querySnapshot.size + ' newsletters', 'success');
          document.getElementById('newsletterData').style.display = 'none';
        } catch (err) {
          log('newsletter', 'âœ— Error: ' + err.message, 'error');
        }
      };

      // Article Tests
      window.testAddArticle = async function() {
        log('article', 'Adding test article...', 'info');
        try {
          await addDoc(collection(db, 'articles'), {
            title: 'TEST ARTICLE',
            content: 'This is a test article created at ' + new Date().toLocaleTimeString(),
            date: new Date().toISOString()
          });
          log('article', 'âœ“ Article added', 'success');
        } catch (err) {
          log('article', 'âœ— Error: ' + err.message, 'error');
        }
      };

      window.testLoadArticles = async function() {
        log('article', 'Loading articles...', 'info');
        try {
          const q = query(collection(db, 'articles'), orderBy('date', 'desc'));
          const querySnapshot = await getDocs(q);
          document.getElementById('articleTable').innerHTML = '';
          
          if (querySnapshot.empty) {
            log('article', 'No articles found', 'warning');
          } else {
            log('article', 'âœ“ Loaded ' + querySnapshot.size + ' articles', 'success');
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const row = document.createElement('tr');
              row.innerHTML = `<td>${data.title}</td><td>${new Date(data.date).toLocaleString()}</td><td>${doc.id}</td>`;
              document.getElementById('articleTable').appendChild(row);
            });
            document.getElementById('articleData').style.display = 'block';
          }
        } catch (err) {
          log('article', 'âœ— Error: ' + err.message, 'error');
        }
      };

      window.testClearArticles = async function() {
        if (!confirm('Delete all articles?')) return;
        log('article', 'Deleting all articles...', 'info');
        try {
          const q = query(collection(db, 'articles'));
          const querySnapshot = await getDocs(q);
          const batch = writeBatch(db);
          
          querySnapshot.forEach((doc) => {
            batch.delete(doc.ref);
          });
          
          await batch.commit();
          log('article', 'âœ“ Deleted ' + querySnapshot.size + ' articles', 'success');
          document.getElementById('articleData').style.display = 'none';
        } catch (err) {
          log('article', 'âœ— Error: ' + err.message, 'error');
        }
      };

      // Listing Tests
      window.testAddListing = async function() {
        log('listing', 'Adding test listing...', 'info');
        try {
          await addDoc(collection(db, 'listings'), {
            title: 'TEST LISTING',
            price: 99.99,
            ebayLink: 'https://ebay.com',
            description: 'Test listing created at ' + new Date().toLocaleTimeString(),
            photo: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect fill="%231a3a6b" width="100" height="100"/%3E%3C/svg%3E',
            date: new Date().toISOString()
          });
          log('listing', 'âœ“ Listing added', 'success');
        } catch (err) {
          log('listing', 'âœ— Error: ' + err.message, 'error');
        }
      };

      window.testLoadListings = async function() {
        log('listing', 'Loading listings...', 'info');
        try {
          const q = query(collection(db, 'listings'), orderBy('date', 'desc'));
          const querySnapshot = await getDocs(q);
          document.getElementById('listingTable').innerHTML = '';
          
          if (querySnapshot.empty) {
            log('listing', 'No listings found', 'warning');
          } else {
            log('listing', 'âœ“ Loaded ' + querySnapshot.size + ' listings', 'success');
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const row = document.createElement('tr');
              row.innerHTML = `<td>${data.title}</td><td>$${data.price}</td><td>${new Date(data.date).toLocaleString()}</td><td>${doc.id}</td>`;
              document.getElementById('listingTable').appendChild(row);
            });
            document.getElementById('listingData').style.display = 'block';
          }
        } catch (err) {
          log('listing', 'âœ— Error: ' + err.message, 'error');
        }
      };

      window.testClearListings = async function() {
        if (!confirm('Delete all listings?')) return;
        log('listing', 'Deleting all listings...', 'info');
        try {
          const q = query(collection(db, 'listings'));
          const querySnapshot = await getDocs(q);
          const batch = writeBatch(db);
          
          querySnapshot.forEach((doc) => {
            batch.delete(doc.ref);
          });
          
          await batch.commit();
          log('listing', 'âœ“ Deleted ' + querySnapshot.size + ' listings', 'success');
          document.getElementById('listingData').style.display = 'none';
        } catch (err) {
          log('listing', 'âœ— Error: ' + err.message, 'error');
        }
      };

      // Auto-test on load
      setTimeout(() => {
        testFirebase();
        testLoadAnnouncement();
      }, 500);
    </script>
  </body>
</html>
